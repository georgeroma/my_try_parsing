(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict";function asyncGeneratorStep(t,e,n,r,s,a,i){try{var o=t[a](i),c=o.value}catch(t){return void n(t)}o.done?e(c):Promise.resolve(c).then(r,s)}function _asyncToGenerator(t){return function(){var e=this,n=arguments;return new Promise(function(r,s){var a=t.apply(e,n);function i(t){asyncGeneratorStep(a,r,s,i,o,"next",t)}function o(t){asyncGeneratorStep(a,r,s,i,o,"throw",t)}i(void 0)})}}!function(){var t=function(){function t(t,e,n,r){this.advGoods=t,this.queryDictionary=e,this.container=n,this.queryHelper=r,this.unshownCards=[],this.advTypeIsSearch=void 0!==e.searchtext,this._doOnEvent=this._doOnEvent.bind(this)}var e=t.prototype;return e.setAdvInfoOnCards=function(){var t=this;if(this._removeShowStatEvents(),Array.isArray(this.advGoods)&&0!==this.advGoods.length){var e=this.container.querySelectorAll(".j-card-item"),n=[];e.forEach(function(e){var r=t.advGoods.find(function(t){return t.nmId==e.dataset.popupNmId});r&&(e.dataset.advStatFields=r.statisticFieldsJson,e.dataset.extraAnaliticsCode=t.queryDictionary.menuId>0?"CAB":"SAB",n.push(e))}),this._bindShownStatistic(n),this._bindClickStatistic(n)}},e.getAdvGoodsAsync=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var n,r,s,a,i,o,c,u,d,h,p,v=this;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.advTypeIsSearch){t.next=14;break}return t.next=3,this._extractParametersForSearch(e,this.queryHelper.getFiltersQuery(new URLSearchParams));case 3:return s=t.sent,a=s.queryModel,i=s.brands,o=s.xInfo,c={method:"POST",body:JSON.stringify({brands:i})},t.next=10,fetch("https://catalog-ads.wildberries.ru/api/v4/search?".concat(a.toString(),"&").concat(o),c).then(function(t){return t.json()});case 10:(u=t.sent)&&(d=[],h=null==u?void 0:u.map(function(t){var e,n;t.priceU=t.price,t.salePriceU=t.salePrice,t.feedbacks=t.feedbackCount,t.pics=t.picsCount;var r=wb.xnm.convertXProductToSpaCatalogProduct(t);r.isAdv=!0;var s={nmId:r.nmId,position:t.position,statisticFieldsJson:JSON.stringify({advertId:t.advertId,position:t.position,cpm:t.cpm,subjectId:r.subjectId,brandId:t.brandId,kindId:null!==(e=null===(n=t.kindIds)||void 0===n?void 0:n[0])&&void 0!==e?e:0})};return d.push(s),r}),r={products:h,advertCardsInfo:d}),t.next=19;break;case 14:return p=this.queryHelper.getFiltersQuery(),Object.keys(this.queryDictionary).forEach(function(t){return p.append(t,v.queryDictionary[t])}),t.next=18,this.$httpClient.fetchJSON("/spa/catalog/advGoods?".concat(p.toString()));case 18:r=t.sent;case 19:return this.advGoods=null===(n=r)||void 0===n?void 0:n.advertCardsInfo,t.abrupt("return",r);case 21:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}(),e.updateModel=function(t,e){this.advGoods=t,this.queryDictionary=e,this.setAdvInfoOnCards()},e.reset=function(){this.advGoods=[],this.unshownCards=[],this._removeShowStatEvents()},e._extractParametersForSearch=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function t(e,n){var r,s,a,i,o,c,u,d,h,p,v;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._getFilters(e);case 2:return o=t.sent,c=o.filters,u=o.xInfo,d=null==c?void 0:null===(r=c.find(function(t){return"xsubject"===t.key}))||void 0===r?void 0:r.items,h=null==c?void 0:null===(s=c.find(function(t){return"fkind"===t.key}))||void 0===s?void 0:s.items,p=null==c?void 0:null===(a=c.find(function(t){return"fcolor"===t.key}))||void 0===a?void 0:a.items,!n.has("xsubject")&&d&&Object.keys(d).length>0&&n.set("ssubject",d.sort(function(t,e){return e.count-t.count}).slice(0,5).map(function(t){return t.id}).join(",")),!n.has("fkind")&&h&&Object.keys(h).length>0&&n.set("skind",h.map(function(t){return t.id}).join(",")),!n.has("fcolor")&&p&&Object.keys(p).length>0&&n.set("scolor",p.map(function(t){return t.id}).join(",")),v=null==c?void 0:null===(i=c.find(function(t){return"fbrand"===t.key}))||void 0===i?void 0:i.items.map(function(t){return t.id}),n.set("search",e.search),t.abrupt("return",{queryModel:n,brands:v,xInfo:u});case 12:case"end":return t.stop()}},t,this)}));return function(e,n){return t.apply(this,arguments)}}(),e._getFilters=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var n,r,s,a;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.$getCurrentXInfoAsync();case 2:return r=t.sent,s="".concat(this._getXpath(e),"/filters?filters=xsubject;fkind;fcolor;fbrand&").concat(r),e.xcatalogQuery&&(s+="&"+e.xcatalogQuery),t.next=7,fetch(s).then(function(t){return t.json()});case 7:return a=t.sent,t.abrupt("return",{filters:null===(n=a.data)||void 0===n?void 0:n.filters,xInfo:r});case 9:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}(),e._getXpath=function(t){return t.isValid?"".concat("ru"===wb.settings.currentLocale?"https://wbxcatalog-ru.wildberries.ru/":"https://wbxcatalog-sng.wildberries.ru/").concat(t.xcatalogShard):"/search/extsearch"},e._bindShownStatistic=function(t){if((null==t?void 0:t.length)>0){var e=this._getCardsByShownType(t),n=e.shown,r=e.unshown;this._sendShownStatistic(n),r.length>0&&(this.unshownCards=r,this._bindShowStatEvents())}},e._bindClickStatistic=function(t){var e=this;t.forEach(function(t){var n=e.$helper.delegator(".j-open-product-popup, .j-open-full-product-card, .j-slider-item, .j-size, .j-add-to-basket, .j-add-to-postpone",function(){e._sendClickStatistic(t),t.removeEventListener("click",n)});t.addEventListener("click",n)})},e._sendShownStatistic=function(t){var e=this;t.forEach(function(t){if(t.dataset.shownStatisticSend=!0,0!=t.clientWidth){var n=e._tryGetStatParams(t);null!=n&&wb.stat.sendEvent(e.advTypeIsSearch?"AFDS":"ACTLS",n,!1)}})},e._tryGetStatParams=function(t){var e=t.dataset.advStatFields,n=t.dataset.popupNmId;if(null==e)return null;try{var r=JSON.parse(e);return this._createStatParams(n,r)}catch(t){return console.error(t),null}},e._createStatParams=function(t,e){var n=[];return this.advTypeIsSearch?(n.push(this.$stat.wrapParam("PARAM1",this.queryDictionary.searchtext)),n.push(this.$stat.wrapParam("PARAM2",e.advertId)),n.push(this.$stat.wrapParam("PARAM3",t)),n.push(this.$stat.wrapParam("PARAM4",e.position)),n.push(this.$stat.wrapParam("PARAM5",e.cpm))):(n.push(this.$stat.wrapParam("MId",this.queryDictionary.menuId)),n.push(this.$stat.wrapParam("ADID",e.advertId)),n.push(this.$stat.wrapParam("NMID",t)),n.push(this.$stat.wrapParam("POS",e.position)),n.push(this.$stat.wrapParam("CPM",e.cpm)),n.push(this.$stat.wrapParam("SID",e.subjectId)),n.push(this.$stat.wrapParam("BRID",e.brandId)),n.push(this.$stat.wrapParam("KID",e.kindId))),n},e._bindShowStatEvents=function(){document.addEventListener("scroll",this._doOnEvent,{passive:!0}),window.addEventListener("resize",this._doOnEvent,{passive:!0})},e._removeShowStatEvents=function(){document.removeEventListener("scroll",this._doOnEvent,{passive:!0}),window.removeEventListener("resize",this._doOnEvent,{passive:!0})},e._getCardsByShownType=function(t){var e=this;return t.reduce(function(t,n){return n.dataset.shownStatisticSend?t:(e.$helper.isElementInViewport(n)?t.shown.push(n):t.unshown.push(n),t)},{shown:[],unshown:[]})},e._doOnEvent=function(){var t=this._getCardsByShownType(this.unshownCards),e=t.shown,n=t.unshown;this._sendShownStatistic(e),0==n.length&&this._removeShowStatEvents()},e._sendClickStatistic=function(t){var e=this._tryGetStatParams(t);null!=e&&this.$stat.sendEvent(this.advTypeIsSearch?"AFDC":"ACTLC",e,!0)},t}();window.__spaModuleManager__.register("advGoods",t)}();

},{}]},{},[1]);
